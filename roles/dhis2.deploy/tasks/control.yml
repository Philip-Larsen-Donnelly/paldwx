---
- debug:
    msg: "{{ instance }}"
# === Stop instance ==========
# stop the instance if running
- name: stop the instance
  systemd:
    state: stopped
    name: dhis2-{{ instance.name }}
  ignore_errors: yes
  when: instance_action == "stop"

- name: add redirect to nginx config
  blockinfile:
    path: "/etc/nginx/conf.d/default.conf"
    block: |
        location /{{ instance.name }} {
            rewrite ^ /{{ instance.name }}_stopped/ ;
        }
        location /{{ instance.name }}_stopped {
            alias /usr/share/nginx/html;
            index stopped.html break;
        }
    marker: "# {mark} ANSIBLE MANAGED BLOCK {{ instance.name }}"
    insertbefore: "# END DHIS2-INSTANCES:"
    state: "{{ instance.state }}"
  notify: reload nginx
  when: instance_action == "stop"


# === Start instance ==========
# start the instance
- name: stop the instance
  systemd:
    state: started
    name: dhis2-{{ instance.name }}
  ignore_errors: yes
  when: instance_action == "start"


# === Stop instance ==========
# restart the instance if running
- name: restart the instance
  systemd:
    state: restarted
    name: dhis2-{{ instance.name }}
  ignore_errors: yes
  when: instance_action == "restart"

- name: remove redirect from nginx config
  blockinfile:
    path: "/etc/nginx/conf.d/default.conf"
    block: |
        location /{{ instance.name }} {
            proxy_pass                http://127.0.0.1:{{ instance.tomcat_port }}/{{ instance.name }};
            proxy_redirect            off;
            proxy_set_header          Host               $host;
            proxy_set_header          X-Real-IP          $remote_addr;
            proxy_set_header          X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header          X-Forwarded-Proto  https;
            #proxy_cache               dhis;
        }
    marker: "# {mark} ANSIBLE MANAGED BLOCK {{ instance.name }}"
    insertbefore: "# END DHIS2-INSTANCES:"
    state: "{{ instance.state }}"
  notify: reload nginx
  when: instance_action == "restart" or instance_action == "start"
